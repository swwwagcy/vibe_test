<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­é–“éŠæˆ²å¤©å¤©è¿”é‘½çŸ³</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 2025 Dark Theme Palette */
            --bg-body: #0B0E14;
            --surface-glass: rgba(30, 35, 48, 0.75);
            --surface-solid: #1C212E;
            --border-subtle: rgba(255, 255, 255, 0.08);
            
            --accent-gold: #FACC15;
            --accent-gold-glow: rgba(250, 204, 21, 0.25);
            --accent-green: #34D399;
            --accent-red: #F43F5E;
            
            --text-main: #FFFFFF;
            --text-muted: #94A3B8;
            --text-dim: #64748B;
            --text-highlight: #E2E8F0;

            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            margin: 0;
            padding: 20px 16px;
            background-color: var(--bg-body);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: var(--text-main);
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(244, 63, 94, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 90% 90%, rgba(250, 204, 21, 0.1) 0%, transparent 50%);
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- Header --- */
        .promo-header { text-align: center; margin-top: 10px; }
        .promo-title {
            margin: 0; font-size: 28px; font-weight: 800;
            background: linear-gradient(135deg, #FFF 30%, var(--accent-gold) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px; line-height: 1.2; margin-bottom: 8px;
        }
        .promo-subtitle { font-size: 13px; color: var(--text-muted); margin: 0 0 16px 0; }
        .game-tags { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; }
        .game-tag {
            font-size: 12px; padding: 6px 12px; border-radius: 20px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-subtle);
            color: var(--text-highlight); display: flex; align-items: center; gap: 4px;
        }

        /* --- Cards --- */
        .card {
            background: var(--surface-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);
            overflow: hidden; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); transition: transform 0.2s;
        }
        .hero-card {
            padding: 24px 20px; text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid rgba(250, 204, 21, 0.3); box-shadow: 0 0 40px -10px var(--accent-gold-glow);
        }
        .hero-label { font-size: 13px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
        .hero-value { font-size: 48px; font-weight: 800; color: var(--accent-gold); text-shadow: 0 0 30px var(--accent-gold-glow); margin: 0; line-height: 1; font-variant-numeric: tabular-nums; }
        
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { display: flex; flex-direction: column; justify-content: center; padding: 20px 16px; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .stat-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

        /* --- Progress Bar --- */
        .progress-section { margin-top: 24px; text-align: left; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: var(--text-muted); font-weight: 600; }
        .progress-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-gold), #FFF); width: 0%; border-radius: 10px; transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1); box-shadow: 0 0 15px var(--accent-gold-glow); }

        /* --- Titles & Tables --- */
        .section-title {
            font-size: 15px; font-weight: 700; color: var(--text-highlight);
            margin-bottom: 12px; padding-left: 4px; border-left: 3px solid var(--accent-gold); line-height: 1;
        }
        .tier-list { display: flex; flex-direction: column; gap: 10px; }
        .tier-item { display: flex; justify-content: space-between; align-items: center; background: var(--surface-solid); padding: 14px 16px; border-radius: var(--radius-sm); border: 1px solid transparent; transition: all 0.3s; }
        .tier-item.active { background: rgba(250, 204, 21, 0.1); border-color: rgba(250, 204, 21, 0.3); transform: scale(1.02); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .tier-range { font-size: 13px; color: var(--text-muted); }
        .tier-rate { font-size: 16px; font-weight: 800; color: var(--text-main); }
        .tier-item.active .tier-rate { color: var(--accent-gold); }

        .history-card { padding: 0; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
        .history-table th { background: rgba(255, 255, 255, 0.03); color: var(--text-muted); font-weight: 600; padding: 14px 16px; font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border-subtle); }
        .history-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); color: var(--text-main); vertical-align: middle; }
        .history-table tr:last-child td { border-bottom: none; }
        .col-amount { text-align: right; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }

        .row-daily-total { background: rgba(250, 204, 21, 0.08) !important; }
        .row-daily-total .col-game { color: var(--accent-gold); font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .row-daily-total .col-game::before { content: 'âˆ‘'; font-weight: 400; opacity: 0.7; }
        .row-daily-total .col-amount { color: var(--accent-gold); font-weight: 800; font-size: 14px; }
        .date-dim { opacity: 0.2; font-family: serif; }

        /* --- Footer --- */
        .footer-rules { margin-top: 10px; padding: 24px 10px; border-top: 1px solid var(--border-subtle); color: var(--text-muted); }
        .footer-title { font-size: 13px; font-weight: 700; color: var(--text-dim); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .rules-list { list-style: none; padding: 0; margin: 0; font-size: 12px; line-height: 1.8; color: var(--text-muted); }
        .rules-list li { position: relative; padding-left: 14px; margin-bottom: 6px; }
        .rules-list li::before { content: "â€¢"; position: absolute; left: 0; color: var(--text-dim); }
        .rule-highlight { color: var(--accent-gold); font-family: 'JetBrains Mono', monospace; background: rgba(250, 204, 21, 0.1); padding: 0 4px; border-radius: 4px; }
        .copyright { margin-top: 30px; text-align: center; font-size: 10px; color: var(--text-dim); opacity: 0.6; }

        /* --- Skeleton & Error --- */
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size: 200% 100%; animation: pulse 1.5s infinite; color: transparent !important; border-radius: 4px; }
        @keyframes pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .error-msg { text-align: center; padding: 40px 20px; color: var(--text-muted); background: var(--surface-glass); border-radius: var(--radius-md); border: 1px dashed var(--border-subtle); }
    </style>
</head>
<body>

    <div class="dashboard-container">
        
        <!-- Header -->
        <header class="promo-header">
            <h1 class="promo-title">ç›´æ’­é–“éŠæˆ²<br>å¤©å¤©è¿”é‘½çŸ³ ğŸ’</h1>
            <p class="promo-subtitle">ç©ç›´æ’­é–“ä»»ä¸€æ¬¾éŠæˆ²ï¼Œå¤©å¤©è¿”é‘½çŸ³ï¼</p>
            <div class="game-tags">
                <span class="game-tag">ğŸ‰ é¾ä¹³é¬¥ç™½è™</span>
                <span class="game-tag">ğŸ’ˆ ä¸€æŸ±æ“å¤©</span>
                <span class="game-tag">ğŸŒªï¸ é‡‘å°„ç‹‚é¢¨</span>
            </div>
        </header>

        <!-- Main Stats -->
        <main id="main-content">
            <!-- Hero Card -->
            <div class="card hero-card">
                <div class="hero-label">âœ¨ é è¨ˆæ˜æ—¥è¿”æ°´ (é‘½)</div>
                <div class="hero-value skeleton" id="val-rebate">00,000</div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span id="tier-status">è¼‰å…¥ä¸­...</span>
                        <span id="next-diff">---</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="progress-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Bento Grid -->
            <div class="bento-grid" style="margin-top: 16px;">
                <div class="card stat-card">
                    <div class="stat-label">ä»Šæ—¥ä¸‹æ³¨ç¸½é»æ•¸</div>
                    <div class="stat-value skeleton" id="val-total">0</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-label">ç•¶å‰æ´»å‹•è³‡æ ¼</div>
                    <div class="stat-value" id="val-qualify" style="font-size: 14px;">---</div>
                </div>
            </div>
        </main>

        <!-- Rules Section -->
        <section>
            <div class="section-title">ğŸ“Š é‘½çŸ³å›é¥‹æ¯”ä¾‹</div>
            <div class="tier-list">
                <div class="tier-item" id="tier-3">
                    <div class="tier-range">1,000 è¬ä»¥ä¸Š</div>
                    <div class="tier-rate">1.8%</div>
                </div>
                <div class="tier-item" id="tier-2">
                    <div class="tier-range">1,000,000 ~ 9,999,999</div>
                    <div class="tier-rate">1.4%</div>
                </div>
                <div class="tier-item" id="tier-1">
                    <div class="tier-range">5,000 ~ 999,999</div>
                    <div class="tier-rate">0.7%</div>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section>
            <div class="section-title">ğŸ“… è¿‘ 3 æ—¥ä¸‹æ³¨ç´€éŒ„</div>
            <div class="card history-card">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th width="20%">æ—¥æœŸ</th>
                            <th width="45%">éŠæˆ²</th>
                            <th width="35%" class="col-amount">ä¸‹æ³¨ç¸½é¡</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                        <tr>
                            <td><div class="skeleton" style="width:30px; height:12px;"></div></td>
                            <td><div class="skeleton" style="width:80px; height:12px;"></div></td>
                            <td><div class="skeleton" style="width:50px; height:12px; float:right;"></div></td>
                        </tr>
                        <tr>
                            <td><div class="skeleton" style="width:30px; height:12px;"></div></td>
                            <td><div class="skeleton" style="width:80px; height:12px;"></div></td>
                            <td><div class="skeleton" style="width:50px; height:12px; float:right;"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Footer Info -->
        <footer class="footer-rules">
            <div class="footer-title">â„¹ï¸ æ´»å‹•èªªæ˜</div>
            <ul class="rules-list">
                <li>æ´»å‹•æœŸé–“ï¼Œæ¯æ—¥ä¸‹æ³¨ç¸½é¡æ»¿ <strong>5,000</strong> é‘½çŸ³å³äº«é‘½çŸ³è¿”é‚„ã€‚</li>
                <li>æ´»å‹•æœŸé–“æ—¥æ—¥è¿”é‘½ï¼Œéš”æ—¥ 01:00 å‰ç™¼æ”¾è‡³æ‰€å±¬å¸³è™Ÿå…§ã€‚</li>
                <li>èˆ‰ä¾‹ï¼š<span class="rule-highlight">11/29 01:00</span> å‰ç™¼æ”¾ 11/28 å…¨å¤©çš„è¿”é‘½ï¼Œæ™‚å€ç‚º UTC+8ã€‚</li>
                <li>åƒ…è¨ˆç›´æ’­é–“ä¸‰æ¬¾éŠæˆ²ï¼šã€Œé¾ä¹³é¬¥ç™½è™ã€ã€ã€Œä¸€æŸ±æ“å¤©ã€ã€ã€Œé‡‘å°„ç‹‚é¢¨ã€ çš„æœ‰æ•ˆæŠ•æ³¨åŠ ç¸½é‘½çŸ³æ•¸ã€‚</li>
                <li>è¿”é‘½æ•¸é‡å››æ¨äº”å…¥å°æ•¸é»å¾Œä¸€ä½ã€‚èˆ‰ä¾‹ï¼šå‰æ—¥ä¸‹æ³¨ 52,400 é‘½æ¬¡æ—¥è¿”æ°´ç‚º 52,400 * 0.7% = 366.8ï¼Œå¯¦éš›å°‡ç™¼æ”¾ <span class="rule-highlight">367</span> é‘½ã€‚</li>
                <li>æŠ•æ³¨æ¨¡å¼ç•°å¸¸è€…ï¼Œç³»çµ±æœ‰æ¬Šå–æ¶ˆè¿”é‘½è³‡æ ¼ã€‚</li>
                <li>è³‡æ–™éœ€ç™»å…¥å¸³è™Ÿä»¥æ­£ç¢ºé¡¯ç¤ºã€‚</li>
            </ul>
            <div class="copyright">Â© 2025 SWAG. ä¿ç•™ä¿®æ”¹ã€è®Šæ›´ã€è§£é‡‹åŠå–æ¶ˆæ´»å‹•ä¹‹æ¬Šåˆ©</div>
        </footer>

    </div>

    <script>
        // â˜…â˜…â˜… è¨­å®šå€ï¼šå·²æ›´æ–°ç‚ºçœŸå¯¦ API â˜…â˜…â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbwRSX20cx5_AJoo1dgXtLHqJikuYVswLcE7--Edn0gWEHUGa25YvveNqSifc0UmRk0B/exec';

        const fmt = (n) => new Intl.NumberFormat('en-US').format(n);

        // æ¸²æŸ“ä¸»ç¨‹å¼
        function renderDashboard(data) {
            // 1. ç§»é™¤è¼‰å…¥å‹•ç•«
            document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));

            // 2. å¡«å…¥åŸºç¤æ•¸æ“š
            document.getElementById('val-rebate').innerText = fmt(data.est_rebate);
            document.getElementById('val-total').innerText = fmt(data.total_bet);

            // 3. ç‹€æ…‹èˆ‡è³‡æ ¼åˆ¤å®š
            const qEl = document.getElementById('val-qualify');
            if (data.total_bet >= 5000) {
                qEl.innerText = "âœ… ç¬¦åˆè³‡æ ¼";
                qEl.style.color = "var(--accent-green)";
            } else {
                qEl.innerText = "â³ å°šæœªé”æ¨™";
                qEl.style.color = "var(--text-muted)";
            }

            // 4. é€²åº¦æ¢é‚è¼¯
            document.getElementById('progress-bar').style.width = `${data.progress_percent}%`;
            
            let statusText = `ç•¶å‰å±¤ç´š ${data.current_rate}%`;
            let diffText = "";

            if (data.next_tier_diff <= 0) {
                diffText = "å·²é”æœ€é«˜å±¤ç´š ğŸš€";
                document.getElementById('next-diff').style.color = "var(--accent-gold)";
            } else {
                diffText = `å·® ${fmt(data.next_tier_diff)} å‡ç´š`;
            }
            document.getElementById('tier-status').innerText = statusText;
            document.getElementById('next-diff').innerText = diffText;

            // 5. è‡ªå‹•é«˜äº®éšæ¢¯è¡¨
            document.querySelectorAll('.tier-item').forEach(el => el.classList.remove('active'));
            if (data.total_bet >= 10000000) document.getElementById('tier-3').classList.add('active');
            else if (data.total_bet >= 1000000) document.getElementById('tier-2').classList.add('active');
            else if (data.total_bet >= 5000) document.getElementById('tier-1').classList.add('active');

            // 6. æ¸²æŸ“æ­·å²ç´€éŒ„è¡¨æ ¼
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';

            if (!data.history_list || data.history_list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px; color:var(--text-muted);">å°šç„¡ç´€éŒ„</td></tr>`;
            } else {
                let lastDate = '';

                data.history_list.forEach(row => {
                    const tr = document.createElement('tr');
                    const isTotal = row.game_name === 'ç•¶æ—¥åŠ ç¸½';
                    
                    if (isTotal) tr.classList.add('row-daily-total');

                    // è™•ç†æ—¥æœŸé¡¯ç¤ºï¼šå¦‚æœè·Ÿä¸Šä¸€è¡Œä¸€æ¨£ï¼Œä¸”ä¸æ˜¯åŠ ç¸½è¡Œï¼Œå°±é¡¯ç¤º " ç¬¦è™Ÿ
                    let dateHtml = row.date_str;
                    if (row.date_str === lastDate && !isTotal) {
                        dateHtml = '<span class="date-dim">"</span>';
                    } else {
                        lastDate = row.date_str;
                    }

                    tr.innerHTML = `
                        <td style="color: var(--text-muted);">${dateHtml}</td>
                        <td class="col-game">${row.game_name}</td>
                        <td class="col-amount">${fmt(row.amount)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

// å•Ÿå‹•å‡½æ•¸
        async function init() {
            try {
                let userId = null;
                const currentUrl = window.location.href; // å–å¾—ç•¶å‰å®Œæ•´ç¶²å€

                // --- æš´åŠ›æœå°‹æ³• ---
                // ä¸ç®¡æ˜¯ ?user_id=... é‚„æ˜¯ #user_id=... é‚„æ˜¯ &user_id=...
                // åªè¦ç¶²å€è£¡æœ‰é€™å€‹å­—ä¸²ï¼Œå°±æŠŠå®ƒæŠ“å‡ºä¾†
                // ([^&#]*) ä»£è¡¨ï¼šæŠ“å–ç›´åˆ°é‡åˆ° & æˆ– # æˆ– çµæŸ ç‚ºæ­¢çš„æ‰€æœ‰å­—å…ƒ
                const regex = /[?&#]user_id=([^&#]*)/i;
                const match = currentUrl.match(regex);

                if (match && match[1]) {
                    userId = match[1];
                }

                // --- å‚™æ¡ˆï¼šå¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œå˜—è©¦è§£ç¢¼ç¶²å€å†æ‰¾ä¸€æ¬¡ ---
                // (è™•ç†è¢« SWAG å¤šé‡ç·¨ç¢¼çš„æƒ…æ³)
                if (!userId) {
                    try {
                        const decodedUrl = decodeURIComponent(currentUrl);
                        const matchDecoded = decodedUrl.match(regex);
                        if (matchDecoded && matchDecoded[1]) {
                            userId = matchDecoded[1];
                        }
                    } catch (e) { console.error("Decode error", e); }
                }

                // --- éŒ¯èª¤è™•ç†èˆ‡é™¤éŒ¯é¡¯ç¤º ---
                if (!userId) {
                    // â˜… é€™è£¡æœƒæŠŠ iframe å¯¦éš›çœ‹åˆ°çš„ç¶²å€å°å‡ºä¾†ï¼Œè®“æˆ‘å€‘çŸ¥é“ç™¼ç”Ÿä»€éº¼äº‹ â˜…
                    document.querySelector('.dashboard-container').innerHTML = `
                        <div class="error-msg" style="text-align:left; word-break:break-all;">
                            <h3>âš ï¸ ç¼ºå°‘ç”¨æˆ¶è³‡è¨Š</h3>
                            <p>ç„¡æ³•è®€å– User IDã€‚</p>
                            <hr style="opacity:0.2; margin:10px 0;">
                            <p style="font-size:11px; color:#ffcc00;">[DEBUG INFO]</p>
                            <p style="font-size:10px; font-family:monospace; color:#aaa;">
                                <strong>Iframe URL:</strong><br>${currentUrl}
                            </p>
                        </div>
                    `;
                    return;
                }
                // ... (å¾Œé¢çš„ fetch ç¨‹å¼ç¢¼ä¿æŒä¸è®Š) ...

                // --- å‘¼å« API (ä¿®æ­£ç‰ˆ) ---
                console.log("UserID Found:", userId);
                
                // â˜…â˜…â˜… ä¿®æ­£é–‹å§‹ï¼šåŠ å…¥ options è¨­å®š â˜…â˜…â˜…
                const response = await fetch(`${API_URL}?user_id=${encodeURIComponent(userId)}`, {
                    method: 'GET',
                    redirect: 'follow', // è·Ÿéš¨ Google çš„è½‰å€
                    mode: 'cors',       // è·¨åŸŸæ¨¡å¼
                    credentials: 'omit' // â˜…é—œéµï¼šä¸å‚³é€ Cookieï¼Œé¿å…è¢« iframe å®‰å…¨æ€§é˜»æ“‹
                });
                // â˜…â˜…â˜… ä¿®æ­£çµæŸ â˜…â˜…â˜…

                const json = await response.json();
                
                // 3. è™•ç†çµæœ
                if (json.status === 'success') {
                    renderDashboard(json.data);
                } else {
                    console.error("API Error:", json.message);
                    document.querySelector('.dashboard-container').innerHTML = `
                        <div class="error-msg">
                            <h3>æ•¸æ“šè®€å–å¤±æ•—</h3>
                            <p>${json.message}</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("Init Error:", e);
                document.querySelector('.dashboard-container').innerHTML = `
                    <div class="error-msg">
                        <h3>é€£ç·šéŒ¯èª¤</h3>
                        <p>ç„¡æ³•é€£æ¥è‡³è³‡æ–™åº«ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
                    </div>
                `;
            }
        }

        // åŸ·è¡Œ
        init();
    </script>
</body>
</html>
